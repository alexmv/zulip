#!/usr/bin/env bash
# Given a Zulip production environment that had been installed with a
# previous version of Zulip, upgrade it to the commit being tested.
# This takes as input the tarball generated by production-build.
set -e
set -x

# Structurally, this script should just call upgrade-zulip.  However,
# because of a set of issues that result in the previously installed
# GitHub Actions Docker containers not actually working on boot, we
# need to do some preparatory steps. It is a goal to delete these
# steps.

# Reinstall rabbitmq-server.
#
# * For rabbitmq-server, we likely need to do this to work around the
# hostname changing on reboot causing RabbitMQ to not boot.
sudo apt-get -y purge rabbitmq-server
sudo cat /var/run/rabbitmq/pid
sudo apt-get -y install rabbitmq-server

# Start the postgresql service.
sudo service postgresql start

FAILED=0
if ! sudo service rabbitmq-server start; then
    FAILED=1
fi

set +x

echo '--- PID file was 341'
echo '--- hostname'
hostname
echo '--- pidfile'
ls /var/run/rabbitmq/pid || true
cat /var/run/rabbitmq/pid || true

echo '--- /var/run ls:'
ls -l /var/run/ || true
echo '--- /var/run/rabbitmq ls:'
ls -l /var/run/rabbitmq || true
echo '--- /var/log ls:'
ls -lrt /var/log
echo '--- rabbitmq log ls:'
ls -lrt /var/log/rabbitmq || true
echo '--- log'
cat /var/log/rabbitmq/startup_log || true
echo '--- err'
cat /var/log/rabbitmq/startup_err || true
echo '--- ps faux'
ps faux
echo '--- end'

exit "$FAILED"
